<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>MyChrome ‚Äì Stoppregistrering</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    html, body { height: 100%; touch-action: manipulation; }
    :root {
      --tile-h: 18vh;      /* kategori-kakel h√∂jd */
      --problem-h: 16vh;   /* problem-knappar h√∂jd */
    }
    .btn-tile { @apply rounded-2xl shadow-md p-6 text-center text-2xl md:text-3xl font-semibold active:scale-[0.98] transition select-none; min-height: var(--tile-h); }
    .btn-problem { @apply rounded-2xl shadow p-6 text-center text-xl md:text-2xl font-medium active:scale-[0.98] transition select-none; min-height: var(--problem-h); }
    .backdrop { background: rgba(0,0,0,0.35); }
    .chip { @apply inline-flex items-center gap-2 px-3 py-1 rounded-xl text-sm border; }
    .icon-xxl { font-size: 3rem; line-height: 1; }
    .icon-img { width: 4rem; height: 4rem; object-fit: cover; border-radius: 1rem; display: inline-block; }
    .icon-thumb { width: 1.75rem; height: 1.75rem; object-fit: cover; border-radius: 0.5rem; display: inline-block; }
  </style>
</head>
<body class="min-h-full bg-slate-50">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="flex items-center justify-between gap-3 mb-4">
      <div id="secretHeader" class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-sky-500/10 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 stroke-sky-600" viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M3 7h18M5 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7"/><path d="M9 7V5a3 3 0 1 1 6 0v2"/></svg>
        </div>
        <div>
          <h1 id="txtTitle" class="text-3xl md:text-4xl font-bold tracking-tight">MyChrome ‚Äì Stoppregistrering</h1>
          <p id="txtSubtitle" class="text-slate-500 text-base md:text-lg">Stora knappar ‚Üí snabb rapport ‚Üí offline-lagring</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="syncChip" class="chip bg-white border-slate-200 text-slate-600">‚Ä¢ <span id="syncText">Offline</span></span>
        <select id="langSelect" class="px-3 py-3 rounded-xl border border-slate-200 bg-white text-base md:text-lg">
          <option value="sv">Svenska</option>
          <option value="en">English</option>
        </select>
        <button id="btnHome" class="hidden btn-tile px-4 py-2 text-base bg-white border border-slate-200">Startsida</button>
        <button id="btnStats" class="btn-tile px-4 py-2 text-base bg-white border border-slate-200">Statistik</button>
        <button id="btnFullscreen" class="btn-tile px-4 py-2 text-base bg-sky-600 text-white">Helsk√§rm</button>
      </div>
    </header>

    <!-- Main views -->
    <main id="viewContainer"></main>

    <!-- Toast -->
    <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 hidden">
      <div class="bg-emerald-600 text-white px-5 py-3 rounded-xl shadow text-lg" id="toastText">Rapport sparad</div>
    </div>
  </div>

  <!-- Modal: confirm only -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center backdrop">
    <div class="bg-white max-w-md w-full mx-4 rounded-3xl p-6 shadow-2xl">
      <h2 id="modalTitle" class="text-2xl font-bold mb-1">Bekr√§fta</h2>
      <p id="modalSubtitle" class="text-slate-500 mb-6"></p>
      <div class="flex justify-end gap-3 pt-2">
        <button id="btnCancel" class="px-4 py-3 rounded-xl border border-slate-200 bg-white text-lg">Avbryt</button>
        <button id="btnConfirm" class="px-4 py-3 rounded-xl bg-sky-600 text-white text-lg">Bekr√§fta</button>
      </div>
    </div>
  </div>

  <!-- Modal: Admin PIN -->
  <div id="pinModal" class="fixed inset-0 hidden items-center justify-center backdrop">
    <div class="bg-white max-w-sm w-full mx-4 rounded-3xl p-6 shadow-2xl">
      <h2 class="text-2xl font-bold mb-1" id="txtAdminLogin">Admin ‚Äì l√•s upp</h2>
      <p class="text-slate-500 mb-4" id="txtAdminHint">H√•ll rubriken intryckt i 2 sek f√∂r att √∂ppna. Ange PIN f√∂r att redigera konfiguration.</p>
      <input id="pinInput" type="password" inputmode="numeric" class="w-full rounded-xl border border-slate-300 bg-slate-50 px-3 py-3 text-xl tracking-widest mb-4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="flex justify-end gap-3">
        <button id="btnPinCancel" class="px-4 py-3 rounded-xl border border-slate-200 bg-white">Avbryt</button>
        <button id="btnPinOk" class="px-4 py-3 rounded-xl bg-sky-600 text-white">OK</button>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="fixed inset-0 hidden items-center justify-center backdrop z-40">
    <div class="bg-white max-w-3xl w-full mx-4 rounded-3xl p-6 shadow-2xl">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold">Konfiguration</h2>
        <div class="flex gap-2">
          <button id="btnAdminExport" class="px-3 py-2 rounded-xl bg-white border border-slate-200">Export JSON</button>
          <button id="btnAdminImport" class="px-3 py-2 rounded-xl bg-white border border-slate-200">Import JSON</button>
          <button id="btnAdminDefaults" class="px-3 py-2 rounded-xl bg-white border border-slate-200">Standard</button>
          <button id="btnAdminClose" class="px-3 py-2 rounded-xl bg-sky-600 text-white">St√§ng & l√•s</button>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold mb-2">Kategorier</h3>
          <ul id="adminCats" class="space-y-2 max-h-[40vh] overflow-auto"></ul>
          <div class="mt-3 flex gap-2">
            <input id="newCatSV" class="flex-1 rounded-xl border border-slate-300 px-3 py-2" placeholder="Ny kategori (SV)" />
            <input id="newCatEN" class="flex-1 rounded-xl border border-slate-300 px-3 py-2" placeholder="New category (EN)" />
            <button id="btnAddCat" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">L√§gg till</button>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Problem</h3>
          <div id="adminProblemsHint" class="text-slate-500 text-sm mb-2">V√§lj kategori f√∂r att hantera problem.</div>
          <ul id="adminProblems" class="space-y-2 max-h-[40vh] overflow-auto"></ul>
          <div class="mt-3 flex gap-2">
            <input id="newProbSV" class="flex-1 rounded-xl border border-slate-300 px-3 py-2" placeholder="Nytt problem (SV)" />
            <input id="newProbEN" class="flex-1 rounded-xl border border-slate-300 px-3 py-2" placeholder="New problem (EN)" />
            <button id="btnAddProb" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">L√§gg till</button>
          </div>
        </div>
      </div>
      <textarea id="adminJson" class="w-full h-40 mt-4 rounded-xl border border-slate-300 p-3 font-mono text-sm" placeholder="{ JSON konfiguration }"></textarea>
      <input id="fileIcon" type="file" accept="image/*" class="hidden" />
    </div>
  </div>

  <script>
    /** I18N **/
    const I18N = {
      sv: { title: 'MyChrome ‚Äì Stoppregistrering', subtitle: 'Stora knappar ‚Üí snabb rapport ‚Üí offline-lagring', home: 'Startsida', stats: 'Statistik', fullscreen: 'Helsk√§rm', confirm_title: 'Bekr√§fta', confirm: 'Bekr√§fta', cancel: 'Avbryt', saved: 'Rapport sparad', summary: 'Sammanfattning', export_csv: 'Exportera CSV', reset: '√Öterst√§ll data', last_reports: 'Senaste rapporter', none: 'Inga data', reports: 'Rapporter', back: '‚Üê Tillbaka', sync: 'Synk', sync_now: 'Synka nu', syncing: 'Synkar‚Ä¶', synced: 'Synkad', offline: 'Offline' },
      en: { title: 'MyChrome ‚Äì Downtime Reporting', subtitle: 'Big buttons ‚Üí quick report ‚Üí offline storage', home: 'Home', stats: 'Statistics', fullscreen: 'Fullscreen', confirm_title: 'Confirm', confirm: 'Confirm', cancel: 'Cancel', saved: 'Report saved', summary: 'Summary', export_csv: 'Export CSV', reset: 'Reset data', last_reports: 'Latest reports', none: 'No data', reports: 'Reports', back: '‚Üê Back', sync: 'Sync', sync_now: 'Sync now', syncing: 'Syncing‚Ä¶', synced: 'Synced', offline: 'Offline' }
    };

    function getLang(){ return localStorage.getItem('mc_lang') || 'sv'; }
    function setLang(l){ localStorage.setItem('mc_lang', l); applyLang(); renderCurrentView(); }
    function t(key){ const lang = getLang(); return I18N[lang]?.[key] ?? I18N['sv'][key] ?? key; }

    function applyLang(){
      document.getElementById('txtTitle').textContent = t('title');
      document.getElementById('txtSubtitle').textContent = t('subtitle');
      document.getElementById('btnHome').textContent = t('home');
      document.getElementById('btnStats').textContent = t('stats');
      document.getElementById('btnFullscreen').textContent = t('fullscreen');
      document.getElementById('syncText').textContent = syncStateText();
      document.getElementById('modalTitle').textContent = t('confirm_title');
      document.getElementById('btnCancel').textContent = t('cancel');
      document.getElementById('btnConfirm').textContent = t('confirm');
      document.getElementById('toastText').textContent = t('saved');
      document.getElementById('langSelect').value = getLang();
    }

    /** CONFIG ‚Äì default + override via localStorage (admin), z obs≈ÇugƒÖ ikon **/
    const DEFAULT_CONFIG = {
      categories: [
        { id: 'klosskap', icon: 'üì¶', label: { sv: 'Klosskap', en: 'Klosskap' }, problems: [
          { id: 'bad_material', icon: 'ü™µ', label: { sv: 'D√•ligt material', en: 'Bad material' } },
          { id: 'print_problem', icon: 'üñ®Ô∏è', label: { sv: 'Printproblem', en: 'Print issue' } },
          { id: 'other', icon: '‚ö†Ô∏è', label: { sv: '√ñvriga problem', en: 'Other issues' } },
        ]},
        { id: 'medmachine', icon: 'üõ†Ô∏è', label: { sv: 'MedMachine', en: 'MedMachine' }, problems: [
          { id: 'sensor', icon: 'üéõÔ∏è', label: { sv: 'Sensorfel', en: 'Sensor fault' } },
          { id: 'justering', icon: 'ü™õ', label: { sv: 'Justering kr√§vs', en: 'Adjustment needed' } },
          { id: 'other', icon: '‚ö†Ô∏è', label: { sv: '√ñvriga problem', en: 'Other issues' } },
        ]},
        { id: 'dackmachine', icon: 'üöß', label: { sv: 'D√§ckMachine', en: 'D√§ckMachine' }, problems: [
          { id: 'material_stop', icon: '‚õî', label: { sv: 'Materialstopp', en: 'Material stop' } },
          { id: 'tryck', icon: 'üí®', label: { sv: 'Tryckproblem', en: 'Pressure issue' } },
          { id: 'other', icon: '‚ö†Ô∏è', label: { sv: '√ñvriga problem', en: 'Other issues' } },
        ]},
        { id: 'assembly', icon: 'üß∞', label: { sv: 'Assembly', en: 'Assembly' }, problems: [
          { id: 'alignment', icon: 'üìê', label: { sv: 'Felaktig inriktning', en: 'Misalignment' } },
          { id: 'skruv', icon: 'üî©', label: { sv: 'Skruv ‚Äì brist', en: 'Screw ‚Äì shortage' } },
          { id: 'other', icon: '‚ûï', label: { sv: '√ñvrigt', en: 'Other' } },
        ]},
        { id: 'portal', icon: 'ü§ñ', label: { sv: 'Portal', en: 'Portal' }, problems: [
          { id: 'robot_stop', icon: '‚èπÔ∏è', label: { sv: 'Robot ‚Äì stopp', en: 'Robot ‚Äì stop' } },
          { id: 'safety', icon: 'üöß', label: { sv: 'S√§kerhet ‚Äì grind', en: 'Safety ‚Äì gate' } },
          { id: 'other', icon: '‚ûï', label: { sv: '√ñvrigt', en: 'Other' } },
        ]},
      ],
    };

    const LS_CONFIG = 'mc_config_v2';
    function loadConfig(){
      try {
        const raw = localStorage.getItem(LS_CONFIG);
        if (!raw) return DEFAULT_CONFIG;
        const cfg = JSON.parse(raw);
        if (!cfg || !Array.isArray(cfg.categories)) return DEFAULT_CONFIG;
        return cfg;
      } catch (e) {
        return DEFAULT_CONFIG;
      }
    }
    function saveConfig(cfg){ localStorage.setItem(LS_CONFIG, JSON.stringify(cfg)); }

    let CONFIG = loadConfig();
    if (!CONFIG || !Array.isArray(CONFIG.categories)) { CONFIG = DEFAULT_CONFIG; saveConfig(CONFIG); }

    const label = (obj) => (obj?.label?.[getLang()] ?? obj?.label?.sv ?? '');
    const isUrlIcon = (val) => {
      if (typeof val !== 'string') return false;
      return val.startsWith('http://') || val.startsWith('https://') || val.startsWith('data:image');
    };
    function iconHtml(item, fallbackEmoji){
      const v = item?.icon;
      if (isUrlIcon(v)) return `<img src="${v}" alt="" class="icon-img mb-2" />`;
      const e = v || fallbackEmoji || '‚ùñ';
      return `<div class="icon-xxl mb-2">${e}</div>`;
    }
    function iconThumbHtml(item, fallbackEmoji){
      const v = item?.icon;
      if (isUrlIcon(v)) return `<img src="${v}" alt="" class="icon-thumb" />`;
      const e = v || fallbackEmoji || '‚ùñ';
      return `<span class="inline-flex items-center justify-center w-7 h-7 rounded-md bg-slate-100">${e}</span>`;
    }

    /** STORAGE ‚Äì offline + optional remote sync **/
    const LS_EVENTS = 'mc_events_v2';
    const LS_COUNTS = 'mc_counts_v2';
    const LS_PENDING = 'mc_pending_v2';

    const SETTINGS = { REMOTE_ENABLED: false, REMOTE_ENDPOINT: '', REMOTE_BATCH: 50 };

    const loadJSON = (key, fallback) => { try { return JSON.parse(localStorage.getItem(key)) ?? fallback } catch { return fallback } };
    const saveJSON = (key, val) => localStorage.setItem(key, JSON.stringify(val));

    function recordEvent(categoryId, problemId) {
      const events = loadJSON(LS_EVENTS, []);
      const ev = { ts: new Date().toISOString(), categoryId, problemId };
      events.push(ev); saveJSON(LS_EVENTS, events);
      const counts = loadJSON(LS_COUNTS, {});
      counts[categoryId] = counts[categoryId] || {}; counts[categoryId][problemId] = (counts[categoryId][problemId] || 0) + 1; saveJSON(LS_COUNTS, counts);
      if (SETTINGS.REMOTE_ENABLED) { const q = loadJSON(LS_PENDING, []); q.push(ev); saveJSON(LS_PENDING, q); scheduleSync(); }
    }

    /** Sync status **/
    let syncTimer = null;
    function scheduleSync(){ clearTimeout(syncTimer); syncTimer = setTimeout(trySync, 500); }
    function syncStateText(){ if (!SETTINGS.REMOTE_ENABLED || !SETTINGS.REMOTE_ENDPOINT || !navigator.onLine) return t('offline'); return t('synced'); }
    function setSyncChip(status){ const chip = document.getElementById('syncChip'); const text = document.getElementById('syncText'); text.textContent = status || syncStateText(); if (status === t('syncing')) { chip.className = 'chip bg-sky-50 border-sky-200 text-sky-700'; } else if (status === t('synced')) { chip.className = 'chip bg-emerald-50 border-emerald-200 text-emerald-700'; } else { chip.className = 'chip bg-white border-slate-200 text-slate-600'; } }
    async function trySync(){ if (!SETTINGS.REMOTE_ENABLED || !SETTINGS.REMOTE_ENDPOINT || !navigator.onLine) { setSyncChip(); return; } const q = loadJSON(LS_PENDING, []); if (!q.length) { setSyncChip(t('synced')); return; } setSyncChip(t('syncing')); const batch = q.slice(0, SETTINGS.REMOTE_BATCH); try { const res = await fetch(SETTINGS.REMOTE_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ events: batch }) }); if (!res.ok) throw new Error('Bad status'); const rest = q.slice(batch.length); saveJSON(LS_PENDING, rest); setSyncChip(rest.length ? t('syncing') : t('synced')); if (rest.length) scheduleSync(); } catch (e) { console.warn('Sync failed', e); setSyncChip(); } }
    window.addEventListener('online', () => trySync()); window.addEventListener('offline', () => setSyncChip());

    /** UI helpers **/
    const viewContainer = document.getElementById('viewContainer');
    const btnHome = document.getElementById('btnHome');
    const btnStats = document.getElementById('btnStats');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const langSelect = document.getElementById('langSelect');

    btnHome.addEventListener('click', () => renderHome());
    btnStats.addEventListener('click', () => renderStats());
    btnFullscreen.addEventListener('click', async () => { try { if (!document.fullscreenElement) { await document.documentElement.requestFullscreen(); } else { await document.exitFullscreen(); } } catch (e) { console.warn(e); } });
    langSelect.addEventListener('change', (e) => setLang(e.target.value));

    function showToast(msg = t('saved')) { const toast = document.getElementById('toast'); document.getElementById('toastText').textContent = msg; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 1200); }

    let CURRENT_VIEW = 'home';
    function renderCurrentView(){ if (CURRENT_VIEW === 'stats') renderStats(); else renderHome(); }

    /** RENDER: Startsida **/
    function renderHome() {
      CURRENT_VIEW = 'home'; btnHome.classList.add('hidden');
      const grid = CONFIG.categories.map(cat => `
        <button class="btn-tile bg-white border border-slate-200 hover:bg-slate-50" data-cat="${cat.id}">
          ${iconHtml(cat, 'üì¶')}
          <div>${label(cat)}</div>
          <div class="mt-1 text-slate-500 text-lg" id="badge-${cat.id}"></div>
        </button>
      `).join('');

      viewContainer.innerHTML = `<section><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">${grid}</div></section>`;

      const counts = loadJSON(LS_COUNTS, {});
      CONFIG.categories.forEach(cat => { const total = Object.values(counts[cat.id] || {}).reduce((a,b)=>a+b,0); const el = document.getElementById(`badge-${cat.id}`); if (el) el.textContent = total ? `${t('reports')}: ${total}` : ''; });
      viewContainer.querySelectorAll('[data-cat]').forEach(btn => { btn.addEventListener('click', () => renderProblems(btn.dataset.cat)); });
    }

    /** RENDER: Problem list **/
    function renderProblems(categoryId) {
      CURRENT_VIEW = 'home'; btnHome.classList.remove('hidden');
      const cat = CONFIG.categories.find(c => c.id === categoryId); if (!cat) return renderHome();

      const grid = cat.problems.map(pb => `
        <button class="btn-problem bg-white border border-slate-200 hover:bg-slate-50" data-problem="${pb.id}">
          ${iconHtml(pb, '‚ö†Ô∏è')}
          <div>${label(pb)}</div>
          <div class="mt-1 text-slate-500 text-lg" id="cnt-${cat.id}-${pb.id}"></div>
        </button>
      `).join('');

      viewContainer.innerHTML = `
        <section>
          <h2 class="text-2xl font-bold mb-3">${label(cat)}</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">${grid}</div>
          <button id="backToHome" class="btn-tile bg-white border border-slate-200">${t('back')}</button>
        </section>
      `;

      const counts = loadJSON(LS_COUNTS, {});
      (cat.problems || []).forEach(pb => { const n = counts?.[cat.id]?.[pb.id] || 0; const el = document.getElementById(`cnt-${cat.id}-${pb.id}`); if (el) el.textContent = n ? `${t('reports')}: ${n}` : ''; });

      document.getElementById('backToHome').addEventListener('click', renderHome);
      viewContainer.querySelectorAll('[data-problem]').forEach(btn => { btn.addEventListener('click', () => openModalConfirm(cat, btn.dataset.problem)); });
    }

    /** Modal (confirm only) **/
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const btnCancel = document.getElementById('btnCancel');
    const btnConfirm = document.getElementById('btnConfirm');

    btnCancel.addEventListener('click', closeModal);
    function openModalConfirm(category, problemId) { const problem = category.problems.find(p => p.id === problemId); modalTitle.textContent = t('confirm_title'); modalSubtitle.textContent = `${label(category)} ‚Üí ${label(problem)}`; btnConfirm.onclick = () => { recordEvent(category.id, problemId); closeModal(); showToast(); renderProblems(category.id); }; modal.classList.remove('hidden'); modal.classList.add('flex'); }
    function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }

    /** RENDER: Statistik + export **/
    function renderStats() {
      CURRENT_VIEW = 'stats'; btnHome.classList.remove('hidden');
      const counts = loadJSON(LS_COUNTS, {}); const events = loadJSON(LS_EVENTS, []);
      let rows = '';
      CONFIG.categories.forEach(cat => { const catCounts = counts[cat.id] || {}; (cat.problems || []).forEach(pb => { const n = catCounts[pb.id] || 0; rows += `<tr class=\"border-b\"><td class=\"p-2\">${iconThumbHtml(cat,'üì¶')} <span class=\"ml-2\">${label(cat)}</span></td><td class=\"p-2\">${iconThumbHtml(pb,'‚ö†Ô∏è')} <span class=\"ml-2\">${label(pb)}</span></td><td class=\"p-2 text-right\">${n}</td></tr>`; }); });
      const last = [...events].slice(-5).reverse().map(ev => { const cat = CONFIG.categories.find(c => c.id === ev.categoryId); const pb = cat?.problems.find(p => p.id === ev.problemId); return `<li class=\"flex items-center justify-between gap-3\"><span>${new Date(ev.ts).toLocaleString()}</span><span>${label(cat) || ev.categoryId} ‚Üí ${label(pb) || ev.problemId}</span></li>` }).join('');
      viewContainer.innerHTML = `
        <section class="grid lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-white rounded-2xl shadow p-4">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-2xl font-bold">${t('summary')}</h2>
              <div class="flex gap-2">
                <button id="btnExportCSV" class="px-3 py-2 rounded-xl bg-sky-600 text-white">${t('export_csv')}</button>
                <button id="btnReset" class="px-3 py-2 rounded-xl bg-white border border-slate-200">${t('reset')}</button>
              </div>
            </div>
            <table class="w-full text-left text-lg">
              <thead>
                <tr class="border-b text-slate-500"><th class="p-2">Kategori</th><th class="p-2">Problem</th><th class="p-2 text-right">${t('reports')}</th></tr>
              </thead>
              <tbody>${rows || `<tr><td class=\"p-2\" colspan=\"3\">${t('none')}</td></tr>`}</tbody>
            </table>
          </div>
          <div class="bg-white rounded-2xl shadow p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-xl font-semibold">${t('last_reports')}</h3>
              <button id="btnSyncNow" class="px-3 py-2 rounded-xl bg-white border border-slate-200">${t('sync_now')}</button>
            </div>
            <ol class="space-y-2 text-lg">${last || `<li>${t('none')}</li>`}</ol>
          </div>
        </section>`;
      document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
      document.getElementById('btnReset').addEventListener('click', () => { if (!confirm('S√§kert att √•terst√§lla alla r√§knare och h√§ndelser?')) return; localStorage.removeItem(LS_COUNTS); localStorage.removeItem(LS_EVENTS); localStorage.removeItem(LS_PENDING); renderStats(); showToast(t('reset')); });
      document.getElementById('btnSyncNow').addEventListener('click', trySync);
    }

    function exportCSV() { const events = loadJSON(LS_EVENTS, []); const header = ['timestamp','category','problem']; const lines = [header.join(',')]; events.forEach(ev => { const cat = CONFIG.categories.find(c => c.id === ev.categoryId); const pb = cat?.problems.find(p => p.id === ev.problemId); const row = [ ev.ts, '"' + (label(cat) || ev.categoryId) + '"', '"' + (label(pb) || ev.problemId) + '"' ]; lines.push(row.join(',')); }); const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const dt = new Date().toISOString().replace(/[:T]/g,'-').slice(0,16); a.download = `mychrome_stopp_${dt}.csv`; a.click(); URL.revokeObjectURL(url); }

    // ===== Admin: ukryty tryb z PIN =====
    const ADMIN_PIN = localStorage.getItem('mc_admin_pin') || '2468';
    const secretHeader = document.getElementById('secretHeader');
    const pinModal = document.getElementById('pinModal');
    const pinInput = document.getElementById('pinInput');
    const btnPinCancel = document.getElementById('btnPinCancel');
    const btnPinOk = document.getElementById('btnPinOk');
    const adminPanel = document.getElementById('adminPanel');
    const btnAdminClose = document.getElementById('btnAdminClose');
    const btnAdminExport = document.getElementById('btnAdminExport');
    const btnAdminImport = document.getElementById('btnAdminImport');
    const btnAdminDefaults = document.getElementById('btnAdminDefaults');
    const adminJson = document.getElementById('adminJson');
    const adminCats = document.getElementById('adminCats');
    const adminProblems = document.getElementById('adminProblems');
    const adminProblemsHint = document.getElementById('adminProblemsHint');
    const newCatSV = document.getElementById('newCatSV');
    const newCatEN = document.getElementById('newCatEN');
    const newProbSV = document.getElementById('newProbSV');
    const newProbEN = document.getElementById('newProbEN');
    const btnAddCat = document.getElementById('btnAddCat');
    const btnAddProb = document.getElementById('btnAddProb');
    const fileIcon = document.getElementById('fileIcon');

    let adminSelectedCatId = null;
    let iconTarget = null; // { type: 'cat'|'prob', catId, probId? }

    // D≈Çugi przytrzymanie (2s) na nag≈Ç√≥wku ‚Üí PIN
    let pressTimer; secretHeader.addEventListener('touchstart', startPress); secretHeader.addEventListener('mousedown', startPress); ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=> secretHeader.addEventListener(ev, clearPress));
    function startPress(){ clearTimeout(pressTimer); pressTimer = setTimeout(()=> openPinModal(), 2000); }
    function clearPress(){ clearTimeout(pressTimer); }

    function openPinModal(){ pinInput.value=''; pinModal.classList.remove('hidden'); pinModal.classList.add('flex'); setTimeout(()=> pinInput.focus(), 50); }
    function closePinModal(){ pinModal.classList.add('hidden'); pinModal.classList.remove('flex'); }
    btnPinCancel.addEventListener('click', closePinModal);
    btnPinOk.addEventListener('click', () => { if (pinInput.value === ADMIN_PIN) { closePinModal(); openAdminPanel(); } else { pinInput.value=''; pinInput.placeholder='Fel PIN'; }});

    function openAdminPanel(){ fillAdminLists(); adminJson.value = JSON.stringify(CONFIG, null, 2); adminPanel.classList.remove('hidden'); adminPanel.classList.add('flex'); }
    function closeAdminPanel(){ adminPanel.classList.add('hidden'); adminPanel.classList.remove('flex'); renderCurrentView(); }
    btnAdminClose.addEventListener('click', closeAdminPanel);

    function fillAdminLists(){
      adminCats.innerHTML = '';
      CONFIG.categories.forEach(cat => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-2 p-2 rounded-xl border';
        li.innerHTML = `<div class=\"flex items-center gap-2\">${iconThumbHtml(cat,'üì¶')}<div class=\"font-medium\">${cat.label.sv} / <span class=\"text-slate-500\">${cat.label.en}</span></div></div>
                        <div class=\"flex items-center gap-2\">
                          <button data-edit=\"${cat.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">V√§lj</button>
                          <button data-iconcat=\"${cat.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">Ikon</button>
                          <button data-emojicat=\"${cat.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">Emoji</button>
                          <button data-clearcat=\"${cat.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">Rensa</button>
                          <button data-del=\"${cat.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">Ta bort</button>
                        </div>`;
        adminCats.appendChild(li);
      });
      adminCats.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> { adminSelectedCatId = b.dataset.edit; fillProblemsFor(adminSelectedCatId); }));
      adminCats.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=> { if (!confirm('Ta bort kategori?')) return; CONFIG.categories = CONFIG.categories.filter(c=> c.id !== b.dataset.del); saveConfig(CONFIG); fillAdminLists(); adminProblems.innerHTML=''; }));
      adminCats.querySelectorAll('[data-iconcat]').forEach(b=> b.addEventListener('click', ()=> { iconTarget = { type:'cat', catId:b.dataset.iconcat }; fileIcon.click(); }));
      adminCats.querySelectorAll('[data-emojicat]').forEach(b=> b.addEventListener('click', ()=> { const cat = CONFIG.categories.find(c=> c.id===b.dataset.emojicat); const val = prompt('Emoji f√∂r kategori:', cat.icon || ''); if (val !== null) { cat.icon = val.trim(); saveConfig(CONFIG); fillAdminLists(); } }));
      adminCats.querySelectorAll('[data-clearcat]').forEach(b=> b.addEventListener('click', ()=> { const cat = CONFIG.categories.find(c=> c.id===b.dataset.clearcat); delete cat.icon; saveConfig(CONFIG); fillAdminLists(); }));
    }

    function fillProblemsFor(catId){
      const cat = CONFIG.categories.find(c=> c.id === catId); if (!cat) return;
      adminProblemsHint.textContent = `${cat.label.sv} / ${cat.label.en}`;
      adminProblems.innerHTML = '';
      cat.problems.forEach(pb => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-2 p-2 rounded-xl border';
        li.innerHTML = `<div class=\"flex items-center gap-2\">${iconThumbHtml(pb,'‚ö†Ô∏è')}<div>${pb.label.sv} / <span class=\"text-slate-500\">${pb.label.en}</span></div></div>
                        <div class=\"flex items-center gap-2\">
                          <button data-iconpb=\"${pb.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">Ikon</button>
                          <button data-emojipb=\"${pb.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">Emoji</button>
                          <button data-clearpb=\"${pb.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">Rensa</button>
                          <button data-delpb=\"${pb.id}\" class=\"px-2 py-1 rounded-lg bg-white border\">Ta bort</button>`;
        adminProblems.appendChild(li);
      });
      adminProblems.querySelectorAll('[data-delpb]').forEach(b=> b.addEventListener('click', ()=> { const cat = CONFIG.categories.find(c=> c.id===catId); cat.problems = cat.problems.filter(p=> p.id !== b.dataset.delpb); saveConfig(CONFIG); fillProblemsFor(catId); }));
      adminProblems.querySelectorAll('[data-iconpb]').forEach(b=> b.addEventListener('click', ()=> { iconTarget = { type:'prob', catId:catId, probId:b.dataset.iconpb }; fileIcon.click(); }));
      adminProblems.querySelectorAll('[data-emojipb]').forEach(b=> b.addEventListener('click', ()=> { const pb = CONFIG.categories.find(c=> c.id===catId).problems.find(p=> p.id===b.dataset.emojipb); const val = prompt('Emoji f√∂r problem:', pb.icon || ''); if (val !== null) { pb.icon = val.trim(); saveConfig(CONFIG); fillProblemsFor(catId); } }));
      adminProblems.querySelectorAll('[data-clearpb]').forEach(b=> b.addEventListener('click', ()=> { const pb = CONFIG.categories.find(c=> c.id===catId).problems.find(p=> p.id===b.dataset.clearpb); delete pb.icon; saveConfig(CONFIG); fillProblemsFor(catId); }));
    }

    fileIcon.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0]; if (!file || !iconTarget) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const dataUrl = reader.result; // data:image/...;base64,
        if (iconTarget.type === 'cat'){
          const cat = CONFIG.categories.find(c=> c.id===iconTarget.catId); if (cat) { cat.icon = dataUrl; saveConfig(CONFIG); fillAdminLists(); if (adminSelectedCatId) fillProblemsFor(adminSelectedCatId); }
        } else if (iconTarget.type === 'prob'){
          const cat = CONFIG.categories.find(c=> c.id===iconTarget.catId); const pb = cat?.problems.find(p=> p.id===iconTarget.probId); if (pb) { pb.icon = dataUrl; saveConfig(CONFIG); fillProblemsFor(iconTarget.catId); }
        }
        iconTarget = null; fileIcon.value = '';
      };
      reader.readAsDataURL(file);
    });

    function slugify(str){ return String(str||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,''); }

    btnAddCat.addEventListener('click', ()=> { const sv = newCatSV.value.trim(); const en = newCatEN.value.trim() || sv; if (!sv) return; const id = slugify(sv); CONFIG.categories.push({ id, label: { sv, en }, problems: [] }); saveConfig(CONFIG); newCatSV.value=''; newCatEN.value=''; fillAdminLists(); });
    btnAddProb.addEventListener('click', ()=> { if (!adminSelectedCatId) { alert('V√§lj kategori f√∂rst'); return; } const sv = newProbSV.value.trim(); const en = newProbEN.value.trim() || sv; if (!sv) return; const id = slugify(`${sv}_${Date.now()%10000}`); const cat = CONFIG.categories.find(c=> c.id===adminSelectedCatId); cat.problems.push({ id, label: { sv, en } }); saveConfig(CONFIG); newProbSV.value=''; newProbEN.value=''; fillProblemsFor(adminSelectedCatId); });

    btnAdminExport.addEventListener('click', ()=> { adminJson.value = JSON.stringify(CONFIG, null, 2); adminJson.select(); document.execCommand('copy'); alert('JSON kopierad till urklipp'); });
    btnAdminImport.addEventListener('click', ()=> { try { const cfg = JSON.parse(adminJson.value); if (!cfg || !Array.isArray(cfg.categories)) throw new Error('Ogiltig konfiguration'); CONFIG = cfg; saveConfig(CONFIG); fillAdminLists(); adminProblems.innerHTML=''; showToast('Konfig sparad'); } catch (e) { alert('Fel JSON: ' + e.message); } });
    btnAdminDefaults.addEventListener('click', ()=> { if (!confirm('√Öterst√§ll till standard?')) return; CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG)); saveConfig(CONFIG); fillAdminLists(); adminProblems.innerHTML=''; showToast('√Öterst√§lld'); });

    // ===== Init =====
    window.addEventListener('DOMContentLoaded', () => {
      try {
        document.getElementById('langSelect').value = getLang();
        applyLang();
        renderHome();
        setSyncChip();
      } catch (e) {
        alert('Init error: ' + e.message);
        console.error(e);
      }
    });
  </script>
</body>
</html>